---
title: redis持久化方式
date: 2019-02-26 
tags:
---

### redis的持久化方式RDB和AOF的区别

<!--more-->

* RDB:指在指定的时间间隔内将内存中的数据集快照写入磁盘，实际操作过程是fork一个子进程，先将数据集写入临时文件，写入成功后，在替换之前的文件，用二进制压缩存储。触发RDB持久化过程分为手动触发和自动触发。

​       优点：

1. 使用单独子进程来进行持久化，主进程不会有任何IO操作，确保了redis的高性能。


2.  一旦采用该方式，整个redis数据库将只包含一个文件，对于文件备份非常完美，用于灾难      性故障的恢复十分合适。

​      缺点：

1. 如果你想保证数据的高可用性，即最大限度的避免数据丢失，那么RDB将不是一个很好的选择。因为系统一旦在定时持久化之前出现宕机现象，此前没有来得及写入磁盘的数据都将丢失。

2. 由于RDB是通过fork子进程来协助完成数据持久化工作的，因此，如果当数据集较大时，可能会导致整个服务器停止服务几百毫秒，甚至是1秒钟

 写入临时文件的时间点可以通过配置文件来确定，通过配置**redis在n秒内如果超过m个key被修改**这执行一次RDB操作，这个操作就类似于在这个时间点来保存一次Redis的所有数据，一次快照数据。所有这个持久化方法也通常叫做snapshots。

​     RDB 默认开启，在配置文件中通过 save  n  m 来决定

save 900 1              #在900秒(15分钟)之后，如果至少有1个key发生变化，则dump内存快照。

save 300 10            #在300秒(5分钟)之后，如果至少有10个key发生变化，则dump内存快照。

save 60 10000        #在60秒(1分钟)之后，如果至少有10000个key发生变化，则dump内存快照

**save命令：** 阻塞当前Redis服务器，直到RDB过程完成为止，对于内存比较大的实例会造成长时间阻塞，先上环境不建议使用 

  **bgsave命令：**Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。阻塞只发生在fork阶段，一段时间很短。

bgsave是针对save的优化，所以redis内部有关RDB的操作都是采用bgsave

bgsave 是主流的触发RDB持久化的方式：

执行bgsave,redis父进程判断当前是否存在子进程，如果有bgsave命令则直接返回，否则父进程执行fork操作创建子进程，fork操作过程中父进程会阻塞，等父进程fork完成后，不再阻塞父进程，可以继续响应其他命令，子进程创建RDB文件，根据父进程内存生成临时快照文件，完成后对原有文件进行原子替换。



* AOF:以独立日志的方式记录每次写命令（记录每次的写、删命令，不记录读），重启时再重新执行AOF文件中命令达到恢复数据的目的。AOF的主要作用是解决了数据持久化的实时性，目前已经是Redis持久化的主流方式。

​      优点：

1. 该机制可以带来更高的数据安全性，即数据持久性，Redis中提供了3中同步策略，即每秒同步、每修改同步和不同步，不同策略效率不同
2. 由于该机制对日志文件的写入操作采用的是append模式，因此在写入过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容，如果设置追加file的时间是1s，如果redis发生故障，最多会丢失1s的数据
3. 如果日志过大，Redis可以自动启用rewrite机制。即Redis以append模式不断的将修改数据写入到老的磁盘文件中，同时Redis还会创建一个新的文件用于记录此期间有哪些修改命令被执行。因此在进行rewrite切换时可以更好的保证数据安全性。

​     缺点：

1. 对于相同数量的数据集而言，AOF文件通常要大于RDB文件
2. 根据同步策略的不同，AOF在运行效率上往往会慢于RDB

​    AOF默认关闭，开启方法，修改配置文件reds.conf： **appendonly yes**

appendfsync always     #每次有数据修改发生时都会写入AOF文件。

appendfsync everysec  #每秒钟同步一次，该策略为AOF的缺省策略。（redis 推荐）

appendfsync no          #从不同步。高效但是数据不会被持久化。

AOF的工作流程操作：命令写入（append）、文件同步（sync）、文件重写（rewrite）、重启加载（load）

所有的写入命令会追加到aof_buf（缓冲区）中，AOF缓冲区根据对应的策略向硬盘做同步操作，随着AOF文件越来越大，需要定期对AOF文件进行重写，达到压缩的目的， 当Redis服务重启时，可以加载AOF文件进行数据恢复。了解AOF工作流程之后，下面针对每个步骤做详细介绍。